<%= turbo_frame_tag "conversation_messages" do %>
  <div class="conversation-container d-flex flex-column">
    <!-- Conversation Header -->
    <div class="conversation-header p-3 bg-white">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-1"><%= @conversation.name.presence || "Untitled Conversation" %></h4>
          <div class="d-flex align-items-center gap-2">
            <% if @conversation.project %>
              <small class="text-muted">
                <i class="fas fa-folder me-2"></i>
                <%= @conversation.project.name %>
              </small>
            <% end %>
            <!-- Participants dropdown -->
            <div class="dropdown">
              <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-users me-1"></i>
                <%= pluralize(@conversation.participants.count, 'participant') %>
              </button>
              <div class="dropdown-menu p-3" style="min-width: 300px;">
                <h6 class="dropdown-header">Participants</h6>
                <div class="participants-list mb-3">
                  <% @conversation.participants.each do |participant| %>
                    <div class="participant d-flex align-items-center justify-content-between py-1">
                      <div class="d-flex align-items-center gap-2">
                        <% if participant.avatar.attached? %>
                          <%= cl_image_tag participant.avatar.key, class: "avatar-small", transformation: [{ width: 24, height: 24, crop: :fill }] %>
                        <% else %>
                          <%= image_tag "https://ui-avatars.com/api/?name=#{participant.username}&size=24&background=random", class: "avatar-small" %>
                        <% end %>
                        <%= participant.username %>
                      </div>
                      <% if current_user == participant %>
                        <span class="badge bg-secondary">You</span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
                
                <!-- Add participant form -->
                <%= form_with(url: add_participant_conversation_path(@conversation), method: :post, class: "add-participant-form") do |f| %>
                  <div class="form-group">
                    <%= f.select :user_id, 
                        User.where.not(id: @conversation.participant_ids).map { |u| [u.username, u.id] },
                        { prompt: "Add participant..." },
                        { 
                          class: "form-select form-select-sm",
                          data: {
                            controller: "tom-select",
                            tom_select_options_value: {
                              placeholder: "Search users...",
                            }
                          }
                        } %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
        <div>
          <%= link_to conversations_path, class: "btn btn-outline-secondary btn-sm" do %>
            <i class="fas fa-times"></i>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Messages Area -->
    <%= turbo_stream_from @conversation %>
    <div id="messages_conversation_<%= @conversation.id %>" 
         class="conversation-messages flex-grow-1"
         data-controller="chat-scroll"
         data-action="turbo:frame-render->chat-scroll#scrollToBottom">
      <%= render @messages || [], current_user: current_user %>
    </div>

    <!-- Message Input -->
    <div class="message-input-container">
      <div id="message_form">
        <%= form_with(model: [@conversation, Message.new], 
                      class: "d-flex align-items-center gap-2",
                      data: { 
                        controller: "reset-form",
                        action: "turbo:submit-end->reset-form#reset"
                      }) do |f| %>
          <%= f.text_field :content, 
              class: "form-control",
              placeholder: "Type your message...",
              autocomplete: "off",
              data: { 
                controller: "textarea-autogrow",
                action: "keydown->textarea-autogrow#submit"
              } %>
          <%= f.button class: "btn btn-send" do %>
            <i class="fas fa-paper-plane text-white"></i>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<% content_for :styles do %>
  <style>
    .message-content {
      word-wrap: break-word;
      max-width: 100%;
    }
    
    .message-bubble {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 12px;
      background-color: #f0f2f5;
      position: relative;
    }

    .message-right .message-bubble {
      background-color: #0084ff;
      color: white;
    }

    .message {
      margin-bottom: 1rem;
    }

    .message-footer {
      font-size: 0.75rem;
      color: #65676b;
      margin-top: 4px;
    }

    .message-right .message-footer {
      color: rgba(255, 255, 255, 0.7);
    }
  </style>
<% end %>
